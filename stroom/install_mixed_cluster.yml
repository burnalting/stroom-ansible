---
########### LOCALHOST  ###########

- name: Verify local_config_dir is set up
  import_playbook: ./verify_local_config_dir_exists.yml

################### SETUP HOST(S) ###################

- name: Setup stroom hosts
  import_playbook: ./setup_stroom_hosts.yml
  tags:
    - setup

########### '.*_stack' HOSTS  ###########

- name: "Deploy stack"
  hosts:
    - stroom_services_stack
  gather_facts: true
  tasks:

    - import_role:
        name: stack/deploy
      tags:
        - deploy

########### stroom and proxy HOSTS  ###########

  # TODO move out into its own playbook, or one for each of stroom and proxy
- hosts:
    - stroom_and_proxy
  gather_facts: true # Needed for yum stuff
  become: true
  become_user: "{{ stroom_user }}"
  vars:
    # non docker stroom
    stroom_home_dir: "{{ stroom_install_root_dir }}/stroom/{{ stroom_version }}"
    stroom_config_dir: "{{ stroom_home_dir }}/config"
    stroom_conf_file: "{{ stroom_config_dir }}/stroom.conf"
    stroom_config_files_and_templates_dir: "{{ local_config_dir }}/files_and_templates/stroom"

    # non docker proxy
    stroom_proxy_home_dir: "{{ stroom_proxy_install_root_dir }}/stroom-proxy/{{ stroom_proxy_version }}"
    stroom_proxy_repo_dir: "{{ stroom_proxy_install_root_dir }}/stroom-proxy/repo"
    stroom_proxy_config_dir: "{{ stroom_proxy_home_dir }}/config"
    stroom_proxy_logs_dir: "{{ stroom_proxy_home_dir }}/logs"
    stroom_proxy_certs_dir: "{{ stroom_proxy_home_dir }}/certs"
    stroom_proxy_content_dir: "{{ stroom_proxy_home_dir }}/content"
    stroom_proxy_config_files_and_templates_dir: "{{ local_config_dir }}/files_and_templates/stroom-proxy"
  tasks:

    - name: 'Check mandatory variables are defined'
      assert:
        that:
          - local_config_dir is defined
          - stroom_install_root_dir is defined
          - stroom_version is defined
          - stroom_user is defined

    # non docker stroom

    - import_role:
        name: non_docker_stroom/download
      tags:
        - deploy

    - import_role:
        name: non_docker_stroom/update_config
      tags:
        - deploy
        - configure

    # non docker proxy

    - import_role:
        name: non_docker_proxy/download
      tags:
        - deploy

    - import_role:
        name: non_docker_proxy/update_config
      tags:
        - deploy
        - configure

